import React, { useState, useEffect } from 'react';

// Iconos (sin cambios)
const ChevronDownIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <polyline points="6 9 12 15 18 9"></polyline>
  </svg>
);
const CheckCircleIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-500">
    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
    <polyline points="22 4 12 14.01 9 11.01"></polyline>
  </svg>
);
const XCircleIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500">
    <circle cx="12" cy="12" r="10"></circle>
    <line x1="15" y1="9" x2="9" y2="15"></line>
    <line x1="9" y1="9" x2="15" y2="15"></line>
  </svg>
);
const LightbulbIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-500">
    <line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line><path d="M9 18h6v2a3 3 0 01-6 0v-2z"></path><path d="M15.5 16.5a4.5 4.5 0 00-7 0"></path><path d="M12 6a3 3 0 00-3 3h6a3 3 0 00-3-3z"></path>
  </svg>
);
const SparklesIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-400">
        <path d="M12 2L14.5 8L21 9.5L16.5 14.5L18 21L12 17.5L6 21L7.5 14.5L3 9.5L9.5 8L12 2z"/>
        <path d="M6.5 2.5L7.5 5L10 5.5L8.5 7.5L9 9.5L7.5 8.5L6 9.5L6.5 7.5L5 5.5L7.5 5L6.5 2.5z"/>
        <path d="M17.5 2.5L16.5 5L14 5.5L15.5 7.5L15 9.5L16.5 8.5L18 9.5L17.5 7.5L19 5.5L16.5 5L17.5 2.5z"/>
    </svg>
);
const LockKeyholeIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2 h-6 w-6 text-pink-400">
        <circle cx="12" cy="16" r="1"/>
        <rect x="3" y="10" width="18" height="12" rx="2"/>
        <path d="M7 10V7a5 5 0 0 1 10 0v3"/>
    </svg>
);


const difficultyLevels = [
  { id: "simple", name: "Simple" },
  { id: "normal", name: "Normal" },
  { id: "difficult", name: "Difícil" },
  { id: "god", name: "God" },
];

const allTopics = [
  { id: "a1_verb_be", name: "Verb to be (am/is/are)" },
  { id: "a1_possessive_adjectives", name: "Possessive Adjectives (my, your, his)" },
  { id: "a1_present_simple_i_you_we_they", name: "Present Simple (I, you, we, they)" },
  { id: "a1_articles_a_an_the", name: "Articles (a/an, the)" },
  { id: "a1_can_cant", name: "can / can't (ability)" },
  { id: "a2_past_simple_be", name: "Past Simple (to be: was/were)" },
  { id: "a2_past_simple_regular", name: "Past Simple (regular verbs)" },
  { id: "a2_past_simple_irregular", name: "Past Simple (common irregular verbs)" },
  { id: "a2_present_continuous", name: "Present Continuous" },
  { id: "a2_countable_uncountable_some_any", name: "Countable/Uncountable, some/any" },
  { id: "b1_present_perfect_yet_already", name: "Present Perfect (for, since, yet, already)" },
  { id: "b1_comparatives_superlatives", name: "Comparatives and Superlatives" },
  { id: "b1_will_going_to", name: "Future: will vs. going to" },
  { id: "b1_first_conditional", name: "First Conditional" },
  { id: "b1_modals_obligation_advice", name: "Modals (have to, must, should)" },
  { id: "b1plus_second_conditional", name: "Second Conditional" },
  { id: "b1plus_passive_voice_present_past", name: "Passive Voice (Present and Past Simple)" },
  { id: "b1plus_reported_speech_statements", name: "Reported Speech (Statements)" },
  { id: "b1plus_phrasal_verbs_common", name: "Common Phrasal Verbs" },
  { id: "b1plus_used_to", name: "used to" },
  { id: "b2_third_conditional", name: "Third Conditional" },
  { id: "b2_present_perfect_continuous", name: "Present Perfect Continuous" },
  { id: "b2_future_continuous_perfect", name: "Future Continuous and Future Perfect" },
  { id: "b2_modals_speculation_deduction", name: "Modals of Speculation and Deduction" },
  { id: "b2_relative_clauses_defining_nondefining", name: "Relative Clauses (defining and non-defining)" },
  { id: "c1_mixed_conditionals", name: "Mixed Conditionals" },
  { id: "c1_inversion_emphasis", name: "Inversion for Emphasis" },
  { id: "c1_advanced_passive_structures", name: "Advanced Passive Structures" },
  { id: "c1_idiomatic_expressions", name: "Idiomatic Expressions" },
  { id: "c1_collocations_phrasal_verbs_advanced", name: "Advanced Collocations and Phrasal Verbs" },
];


function ApiKeyModal({ onSubmit, apiKey, setApiKey, error, isLoading }) {
    return (
        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div className="bg-slate-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md">
                <div className="flex items-center justify-center mb-6">
                    <LockKeyholeIcon />
                    <h2 className="text-2xl font-bold text-pink-400 text-center ml-2">Ingresa tu API Key de Gemini</h2>
                </div>
                <p className="text-slate-400 text-sm mb-4 text-center">
                    Para utilizar FlorIA, necesitas una API Key de Google AI Studio (Gemini).
                    Esta clave se usará localmente en tu navegador y no se almacenará en ningún servidor.
                </p>
                <form onSubmit={(e) => { e.preventDefault(); onSubmit(); }}>
                    <input
                        type="password"
                        value={apiKey}
                        onChange={(e) => setApiKey(e.target.value)}
                        placeholder="Tu API Key aquí"
                        className="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all mb-4"
                        disabled={isLoading}
                    />
                    {error && <p className="text-red-400 text-sm mb-4 text-center">{error}</p>}
                    <button
                        type="submit"
                        disabled={isLoading || !apiKey.trim()}
                        className="w-full bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                    >
                        {isLoading ? (
                            <>
                                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Validando...
                            </>
                        ) : "Validar y Continuar"}
                    </button>
                </form>
                 <p className="text-slate-500 text-xs mt-6 text-center">
                    Puedes obtener una API Key en <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-pink-400 hover:underline">Google AI Studio</a>.
                </p>
            </div>
        </div>
    );
}


function App() {
  const [selectedTopic, setSelectedTopic] = useState(allTopics[0].id);
  const [selectedDifficulty, setSelectedDifficulty] = useState(difficultyLevels[0].id);
  
  const [exercise, setExercise] = useState(null);
  const [userAnswers, setUserAnswers] = useState({});
  const [validationResults, setValidationResults] = useState(null);
  const [isLoadingExercise, setIsLoadingExercise] = useState(false);
  const [isLoadingValidation, setIsLoadingValidation] = useState(false);
  const [error, setError] = useState(null);
  
  // Estados para la API Key
  const [globalApiKey, setGlobalApiKey] = useState(""); // Esta es la que usará la app una vez validada
  const [inputApiKey, setInputApiKey] = useState(""); // Para el campo del modal
  const [isApiKeyModalOpen, setIsApiKeyModalOpen] = useState(true);
  const [isApiKeyValid, setIsApiKeyValid] = useState(false);
  const [apiKeyError, setApiKeyError] = useState("");
  const [isLoadingApiKeyValidation, setIsLoadingApiKeyValidation] = useState(false);


  // Nuevos estados para las funcionalidades con IA
  const [deeperExplanation, setDeeperExplanation] = useState("");
  const [isLoadingDeeperExplanation, setIsLoadingDeeperExplanation] = useState(false);
  const [miniStory, setMiniStory] = useState("");
  const [isLoadingMiniStory, setIsLoadingMiniStory] = useState(false);

  const API_URL_GEMINI_BASE = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`;

  useEffect(() => {
    setExercise(null);
    setUserAnswers({});
    setValidationResults(null);
    setError(null);
    setDeeperExplanation(""); 
    setMiniStory(""); 
  }, [selectedTopic, selectedDifficulty]);

  const handleTopicChange = (event) => {
    setSelectedTopic(event.target.value);
  };

  const handleDifficultyChange = (event) => {
    setSelectedDifficulty(event.target.value);
  };

  const validateAndSetApiKey = async () => {
    if (!inputApiKey.trim()) {
        setApiKeyError("Por favor, ingresa una API Key.");
        return;
    }
    setIsLoadingApiKeyValidation(true);
    setApiKeyError("");

    try {
        const testPrompt = "Responde 'OK' si esta API key funciona.";
        const payload = { contents: [{ role: "user", parts: [{ text: testPrompt }] }] };
        const response = await fetch(`${API_URL_GEMINI_BASE}?key=${inputApiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            // const result = await response.json(); // Opcional: verificar contenido de result si es necesario
            setGlobalApiKey(inputApiKey);
            setIsApiKeyValid(true);
            setIsApiKeyModalOpen(false);
        } else {
            // No mostrar response.statusText directamente al usuario por seguridad/simplicidad
            setApiKeyError("API Key incorrecta o inválida. Inténtalo nuevamente.");
            console.error("API Key validation failed:", response.status, await response.text());
        }
    } catch (err) {
        console.error("Error validating API Key:", err);
        setApiKeyError("Error al validar la API Key. Verifica tu conexión o la clave.");
    } finally {
        setIsLoadingApiKeyValidation(false);
    }
  };


  const generateExercise = async () => {
    if (!selectedTopic || !selectedDifficulty || !isApiKeyValid) return;
    setIsLoadingExercise(true);
    setError(null);
    setValidationResults(null);
    setUserAnswers({});
    setDeeperExplanation("");
    setMiniStory("");

    const topicName = allTopics.find(t => t.id === selectedTopic)?.name || selectedTopic;
    const difficultyName = difficultyLevels.find(d => d.id === selectedDifficulty)?.name || selectedDifficulty;
    
    const prompt = `Eres un profesor de inglés experto. Genera un ejercicio de aprendizaje de inglés sobre el tema '${topicName}' con un nivel de dificultad '${difficultyName}'.
    El ejercicio debe incluir:
    1.  Una breve explicación del tema '${topicName}' en español, concisa y clara (máximo 3-4 frases). La explicación debe ser comprensible independientemente de la dificultad del ejercicio, pero puedes sutilmente ajustar la profundidad si es relevante.
    2.  Exactamente 5 frases en inglés con un espacio en blanco (representado como {blank}) para ser rellenado. Las frases, el vocabulario y la complejidad gramatical deben ser apropiados para la dificultad '${difficultyName}' aplicada al tema '${topicName}'.
        - Para dificultad 'Simple': frases cortas, vocabulario común, estructuras directas.
        - Para dificultad 'Normal': frases de longitud media, vocabulario estándar, estructuras comunes del tema.
        - Para dificultad 'Difícil': frases más largas o complejas, vocabulario más rico o específico, estructuras más elaboradas del tema.
        - Para dificultad 'God': frases desafiantes, vocabulario avanzado o poco común, matices sutiles del tema, posibles distractores complejos.
    3.  Para cada frase, proporciona 4 opciones en inglés: 3 incorrectas y 1 correcta para el espacio en blanco. Las opciones deben ser plausibles pero solo una correcta, y su complejidad debe coincidir con la dificultad '${difficultyName}'.
    4.  Indica cuál es la respuesta correcta para cada frase.
    5.  Proporciona una frase de ejemplo en inglés que demuestre el uso correcto para cada una de las 5 frases del ejercicio, también adaptada a la dificultad '${difficultyName}'.

    Formato de respuesta JSON esperado:
    {
      "topicExplanation": "Explicación breve del tema...",
      "questions": [
        {
          "id": "q1",
          "sentence": "If it {blank} tomorrow, we will go to the beach.",
          "options": ["rain", "rains", "will rain", "raining"],
          "correctAnswer": "rains",
          "example": "If the weather is good, we usually go for a walk."
        }
        // ... 4 preguntas más
      ]
    }

    Asegúrate de que las opciones y la respuesta correcta sean relevantes para el tema '${topicName}' y la dificultad '${difficultyName}'.
    Varía la estructura de las frases.
    El JSON debe ser válido.`;

    try {
      const payload = {
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: {
          responseMimeType: "application/json",
        }
      };
      const response = await fetch(`${API_URL_GEMINI_BASE}?key=${globalApiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error("Error from API:", errorData);
        if (response.status === 400 || response.status === 403) { // Errores comunes de API Key
            setError("Hubo un problema con la API Key al generar el ejercicio. Intenta recargar la página y reingresar la clave.");
            setIsApiKeyValid(false); // Invalidar la clave para forzar el modal
            setIsApiKeyModalOpen(true);
        } else {
            throw new Error(`Error de API: ${response.statusText}. ${errorData?.error?.message || ''}`);
        }
        return; // Detener ejecución si hay error de API
      }

      const result = await response.json();
      
      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const text = result.candidates[0].content.parts[0].text;
        const parsedExercise = JSON.parse(text);
        
        if (!parsedExercise.topicExplanation || !parsedExercise.questions || parsedExercise.questions.length !== 5) {
            throw new Error("La respuesta de la IA no tiene el formato esperado o no contiene 5 preguntas.");
        }
        parsedExercise.questions.forEach((q, index) => q.id = `q${index + 1}`);
        setExercise(parsedExercise);
        setUserAnswers(parsedExercise.questions.reduce((acc, q) => ({ ...acc, [q.id]: "" }), {}));

      } else {
        console.error("Respuesta inesperada de la API:", result);
        throw new Error("No se pudo generar el ejercicio. Respuesta inesperada de la API.");
      }
    } catch (err) {
      console.error("Error generando ejercicio:", err);
      setError(`Error al generar ejercicio: ${err.message}. Intenta de nuevo o revisa la consola para más detalles.`);
      setExercise(null);
    } finally {
      setIsLoadingExercise(false);
    }
  };

  const handleAnswerChange = (questionId, answer) => {
    setUserAnswers(prev => ({ ...prev, [questionId]: answer }));
  };

  const validateWithAI = async () => {
    if (!exercise || Object.values(userAnswers).some(ans => ans === "") || !isApiKeyValid) {
      setError("Por favor, completa todas las respuestas antes de validar.");
      return;
    }
    setIsLoadingValidation(true);
    setError(null);
    setValidationResults(null);
    setMiniStory(""); 

    const topicName = allTopics.find(t => t.id === selectedTopic)?.name || selectedTopic;
    const difficultyName = difficultyLevels.find(d => d.id === selectedDifficulty)?.name || selectedDifficulty;
    const exerciseDetails = exercise.questions.map(q => ({
      question: q.sentence,
      options: q.options,
      correctAnswer: q.correctAnswer,
      userAnswer: userAnswers[q.id]
    }));

    const prompt = `Eres un tutor de inglés experto y amigable. Un estudiante ha completado un ejercicio sobre '${topicName}' con dificultad '${difficultyName}'.
    Aquí están los detalles del ejercicio y sus respuestas:
    ${JSON.stringify(exerciseDetails, null, 2)}

    Por favor, evalúa el rendimiento del estudiante. Proporciona:
    1.  Un puntaje general (número de respuestas correctas de 5).
    2.  Feedback específico para CADA PREGUNTA, incluso si la respuesta es correcta.
        - Si es correcta, felicita y refuerza por qué es correcta, considerando el tema y la dificultad '${difficultyName}'.
        - Si es incorrecta, explica amablemente por qué la respuesta del usuario es incorrecta y por qué la respuesta correcta es la adecuada, haciendo referencia a la regla gramatical del '${topicName}' y adaptando la explicación a la dificultad '${difficultyName}'.
    3.  De 2 a 3 "Tips para mejorar" generales y accionables en español relacionados con el tema '${topicName}' y los errores comunes que el estudiante podría haber cometido, o para reforzar el aprendizaje, considerando la dificultad '${difficultyName}'. Los tips deben ser concisos.

    Formato de respuesta JSON esperado:
    {
      "score": 3,
      "feedback": [
        {
          "question": "Frase original...",
          "userAnswer": "Respuesta del usuario",
          "correctAnswer": "Respuesta correcta",
          "isCorrect": true/false,
          "explanation": "Explicación detallada..."
        }
        // ... feedback para las 5 preguntas
      ],
      "generalTips": [
        "Tip 1...",
        "Tip 2..."
      ]
    }
    El feedback y los tips deben estar en español. Sé alentador y constructivo.
    El JSON debe ser válido.`;

    try {
      const payload = {
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: {
          responseMimeType: "application/json",
        }
      };
      const response = await fetch(`${API_URL_GEMINI_BASE}?key=${globalApiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error("Error from API validation:", errorData);
         if (response.status === 400 || response.status === 403) {
            setError("Hubo un problema con la API Key al validar. Intenta recargar la página y reingresar la clave.");
            setIsApiKeyValid(false);
            setIsApiKeyModalOpen(true);
        } else {
            throw new Error(`Error de API en validación: ${response.statusText}. ${errorData?.error?.message || ''}`);
        }
        return;
      }
      
      const result = await response.json();

      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const text = result.candidates[0].content.parts[0].text;
        const parsedValidation = JSON.parse(text);

        if (typeof parsedValidation.score !== 'number' || !parsedValidation.feedback || parsedValidation.feedback.length !== 5 || !parsedValidation.generalTips) {
            throw new Error("La respuesta de validación de la IA no tiene el formato esperado.");
        }
        setValidationResults(parsedValidation);

      } else {
        console.error("Respuesta inesperada de la API de validación:", result);
        throw new Error("No se pudo validar el ejercicio. Respuesta inesperada de la API.");
      }
    } catch (err) {
      console.error("Error validando respuestas:", err);
      setError(`Error al validar respuestas: ${err.message}. Intenta de nuevo o revisa la consola.`);
    } finally {
      setIsLoadingValidation(false);
    }
  };

  const fetchDeeperExplanation = async () => {
    if (!exercise || !selectedTopic || !selectedDifficulty || !isApiKeyValid) return;
    setIsLoadingDeeperExplanation(true);
    setDeeperExplanation("");
    setError(null);

    const topicName = allTopics.find(t => t.id === selectedTopic)?.name || selectedTopic;
    const difficultyName = difficultyLevels.find(d => d.id === selectedDifficulty)?.name || selectedDifficulty;

    const prompt = `Eres un profesor de inglés experto. Proporciona una explicación más profunda y detallada sobre el tema gramatical '${topicName}' en español. 
    Considera el nivel de dificultad '${difficultyName}' para ajustar la complejidad del lenguaje usado en tu explicación, pero el contenido debe ser exhaustivo.
    Incluye:
    - Una descripción clara de la regla gramatical.
    - Casos de uso comunes.
    - Ejemplos variados (al menos 3-4), diferentes a los que podrían estar en un ejercicio simple.
    - Posibles excepciones o errores comunes a evitar, si aplica.
    - Consejos para recordar o practicar el tema.
    La explicación debe ser enteramente en español.`;

    try {
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        const response = await fetch(`${API_URL_GEMINI_BASE}?key=${globalApiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) {
            if (response.status === 400 || response.status === 403) {
                setError("Hubo un problema con la API Key al buscar explicación. Intenta recargar la página y reingresar la clave.");
                setIsApiKeyValid(false);
                setIsApiKeyModalOpen(true);
            } else {
                 throw new Error(`API error: ${response.statusText}`);
            }
            return;
        }
        const result = await response.json();
        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
            setDeeperExplanation(result.candidates[0].content.parts[0].text);
        } else {
            throw new Error("Respuesta inesperada de la API para explicación profunda.");
        }
    } catch (err) {
        console.error("Error fetching deeper explanation:", err);
        setError(`Error al obtener explicación profunda: ${err.message}`);
    } finally {
        setIsLoadingDeeperExplanation(false);
    }
  };

  const generateMiniStory = async () => {
    if (!selectedTopic || !selectedDifficulty || !isApiKeyValid) return;
    setIsLoadingMiniStory(true);
    setMiniStory("");
    setError(null);

    const topicName = allTopics.find(t => t.id === selectedTopic)?.name || selectedTopic;
    const difficultyName = difficultyLevels.find(d => d.id === selectedDifficulty)?.name || selectedDifficulty;

    const prompt = `Eres un escritor creativo y profesor de inglés. Escribe una mini-historia (3 a 5 frases cortas) en inglés.
    La historia debe:
    - Utilizar prominentemente el tema gramatical: '${topicName}'.
    - Ser adecuada para un estudiante de inglés con un nivel de dificultad general '${difficultyName}'.
    - Ser interesante y coherente.
    - Estar completamente en inglés.
    Al final de la historia, añade una traducción muy breve al español de la historia completa, entre paréntesis. Ejemplo: "(Traducción: ...)"`;
    
    try {
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        const response = await fetch(`${API_URL_GEMINI_BASE}?key=${globalApiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
         if (!response.ok) {
            if (response.status === 400 || response.status === 403) {
                setError("Hubo un problema con la API Key al generar la historia. Intenta recargar la página y reingresar la clave.");
                setIsApiKeyValid(false);
                setIsApiKeyModalOpen(true);
            } else {
                 throw new Error(`API error: ${response.statusText}`);
            }
            return;
        }
        const result = await response.json();
        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
            setMiniStory(result.candidates[0].content.parts[0].text);
        } else {
            throw new Error("Respuesta inesperada de la API para mini-historia.");
        }
    } catch (err) {
        console.error("Error generating mini story:", err);
        setError(`Error al generar mini-historia: ${err.message}`);
    } finally {
        setIsLoadingMiniStory(false);
    }
  };
  
  if (!isApiKeyValid) {
    return (
        <ApiKeyModal 
            onSubmit={validateAndSetApiKey}
            apiKey={inputApiKey}
            setApiKey={setInputApiKey}
            error={apiKeyError}
            isLoading={isLoadingApiKeyValidation}
        />
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-700 via-pink-600 to-orange-500 text-slate-100 font-sans p-4 sm:p-8 flex flex-col items-center">
      <div className="w-full max-w-3xl bg-slate-800/80 backdrop-blur-md shadow-2xl rounded-xl p-6 sm:p-8">
        <header className="mb-8 text-center">
          <h1 className="text-5xl sm:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 via-rose-400 to-amber-300">
            FlorIA
          </h1>
          <p className="text-slate-300 mt-2 text-sm sm:text-base">Tu asistente IA para conquistar el inglés.</p>
        </header>
        
        <section className="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
          <div>
            <label htmlFor="topic-select" className="block text-lg font-semibold text-pink-400 mb-2">
              Elige un tema:
            </label>
            <div className="relative">
              <select
                id="topic-select"
                value={selectedTopic}
                onChange={handleTopicChange}
                className="w-full appearance-none p-3 pr-10 rounded-lg bg-slate-700 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all text-base"
              >
                {allTopics.map(topic => (
                  <option key={topic.id} value={topic.id} className="bg-slate-700 text-slate-100">
                    {topic.name}
                  </option>
                ))}
              </select>
              <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                <ChevronDownIcon />
              </div>
            </div>
          </div>

          <div>
            <label htmlFor="difficulty-select" className="block text-lg font-semibold text-pink-400 mb-2">
              Elige la dificultad:
            </label>
            <div className="relative">
              <select
                id="difficulty-select"
                value={selectedDifficulty}
                onChange={handleDifficultyChange}
                className="w-full appearance-none p-3 pr-10 rounded-lg bg-slate-700 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all text-base"
              >
                {difficultyLevels.map(level => (
                  <option key={level.id} value={level.id} className="bg-slate-700 text-slate-100">
                    {level.name}
                  </option>
                ))}
              </select>
              <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                <ChevronDownIcon />
              </div>
            </div>
          </div>
        </section>
        <button
            onClick={generateExercise}
            disabled={isLoadingExercise || !selectedTopic || !selectedDifficulty}
            className="w-full bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
          >
            {isLoadingExercise ? (
              <>
                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Generando ejercicio...
              </>
            ) : "Generar Ejercicio"}
          </button>

        {error && (
          <div className="my-6 p-4 bg-red-900/50 border border-red-700 text-red-300 rounded-lg text-sm">
            <p className="font-semibold">¡Oops! Algo salió mal:</p>
            <p>{error}</p>
          </div>
        )}

        {exercise && !isLoadingExercise && (
          <section className="mt-8 mb-8 p-6 bg-slate-700/60 rounded-xl border border-slate-600">
            <h2 className="text-2xl font-semibold text-pink-300 mb-3">
              {allTopics.find(t => t.id === selectedTopic)?.name} 
              <span className="text-base text-slate-400 ml-2">({difficultyLevels.find(d => d.id === selectedDifficulty)?.name})</span>
            </h2>
            {exercise.topicExplanation && (
              <div className="text-slate-300 mb-4 text-sm italic bg-slate-600/70 p-3 rounded-md">
                <p>{exercise.topicExplanation}</p>
                <button
                    onClick={fetchDeeperExplanation}
                    disabled={isLoadingDeeperExplanation}
                    className="mt-3 text-xs bg-sky-600 hover:bg-sky-700 text-white py-1 px-3 rounded-md transition-colors flex items-center disabled:opacity-60"
                >
                    {isLoadingDeeperExplanation ? 'Cargando...' : '✨ Explicación Más Profunda'}
                    {!isLoadingDeeperExplanation && <SparklesIcon />}
                </button>
              </div>
            )}
             {isLoadingDeeperExplanation && <div className="text-center my-4"><p className="text-sky-300">Buscando explicación más profunda...</p></div>}
             {deeperExplanation && !isLoadingDeeperExplanation && (
                <div className="my-4 p-4 bg-sky-800/30 border border-sky-700 rounded-lg text-sm text-slate-200 whitespace-pre-wrap">
                    <h4 className="font-semibold text-sky-300 mb-2">Explicación Detallada:</h4>
                    {deeperExplanation}
                </div>
             )}
            
            <form>
              {exercise.questions.map((q, index) => (
                <div key={q.id} className="mb-8 p-4 border border-slate-500 rounded-lg bg-slate-700 shadow">
                  <p className="text-slate-300 mb-1 text-sm">Pregunta {index + 1} de {exercise.questions.length}</p>
                  <p className="text-lg text-slate-100 mb-3">{q.sentence.replace('{blank}', '______')}</p>
                  
                  <label htmlFor={`q-${q.id}`} className="sr-only">Respuesta para la pregunta {index + 1}</label>
                  <div className="relative">
                    <select
                      id={`q-${q.id}`}
                      value={userAnswers[q.id] || ""}
                      onChange={(e) => handleAnswerChange(q.id, e.target.value)}
                      className="w-full appearance-none p-3 pr-10 rounded-md bg-slate-600 border border-slate-500 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all"
                      disabled={isLoadingValidation || validationResults}
                    >
                      <option value="" disabled>Selecciona una opción...</option>
                      {q.options.map((opt, i) => (
                        <option key={i} value={opt} className="bg-slate-600 text-slate-100">{opt}</option>
                      ))}
                    </select>
                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                        <ChevronDownIcon />
                    </div>
                  </div>
                  {q.example && (
                    <p className="mt-3 text-xs text-slate-400 italic">
                      <span className="font-semibold text-pink-400">Ejemplo:</span> {q.example}
                    </p>
                  )}
                </div>
              ))}
              <button
                type="button"
                onClick={validateWithAI}
                disabled={isLoadingValidation || validationResults || Object.values(userAnswers).some(ans => ans === "")}
                className="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
              >
                {isLoadingValidation ? (
                  <>
                    <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Validando con IA...
                  </>
                ) : "Validar con IA"}
              </button>
            </form>
          </section>
        )}

        {validationResults && !isLoadingValidation && (
          <section className="mt-8 p-6 bg-slate-700/70 rounded-xl border border-slate-600 shadow-inner">
            <h2 className="text-3xl font-semibold text-pink-300 mb-6 text-center">Resultados y Feedback</h2>
            <div className="mb-6 p-4 bg-pink-800/50 rounded-lg text-center">
              <p className="text-xl text-slate-100">Tu puntaje:</p>
              <p className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-orange-300 my-2">
                {validationResults.score} / {exercise.questions.length}
              </p>
            </div>

            <div className="space-y-6 mb-8">
              {validationResults.feedback.map((fb, index) => (
                <div key={index} className={`p-4 rounded-lg border ${fb.isCorrect ? 'border-green-600 bg-green-900/40' : 'border-red-600 bg-red-900/40'}`}>
                  <div className="flex items-center mb-2">
                    {fb.isCorrect ? <CheckCircleIcon /> : <XCircleIcon />}
                    <h4 className="ml-2 text-lg font-semibold text-slate-100">Pregunta: "{fb.question.replace('{blank}', '...')}"</h4>
                  </div>
                  <p className={`text-sm ${fb.isCorrect ? 'text-green-300' : 'text-red-300'}`}>
                    Tu respuesta: <span className="font-medium">{fb.userAnswer || "(No respondida)"}</span>
                    {!fb.isCorrect && <span className="ml-2">| Correcta: <span className="font-medium">{fb.correctAnswer}</span></span>}
                  </p>
                  <p className="mt-2 text-slate-300 text-sm">{fb.explanation}</p>
                </div>
              ))}
            </div>

            {validationResults.generalTips && validationResults.generalTips.length > 0 && (
              <div className="mb-6">
                <h3 className="text-xl font-semibold text-pink-400 mb-3 flex items-center">
                  <LightbulbIcon /> <span className="ml-2">Tips para Mejorar:</span>
                </h3>
                <ul className="list-disc list-inside space-y-2 pl-4 text-slate-300 text-sm">
                  {validationResults.generalTips.map((tip, i) => (
                    <li key={i} className="bg-slate-600/70 p-2 rounded-md">{tip}</li>
                  ))}
                </ul>
              </div>
            )}
            
            <div className="mt-6">
                <button
                    onClick={generateMiniStory}
                    disabled={isLoadingMiniStory}
                    className="w-full bg-gradient-to-r from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out flex items-center justify-center disabled:opacity-60"
                >
                    {isLoadingMiniStory ? 'Creando historia...' : '✨ Crear Mini-Historia con este Tema'}
                    {!isLoadingMiniStory && <SparklesIcon />}
                </button>
                {isLoadingMiniStory && <div className="text-center my-4"><p className="text-teal-300">Generando mini-historia...</p></div>}
                {miniStory && !isLoadingMiniStory && (
                    <div className="my-4 p-4 bg-teal-800/30 border border-teal-700 rounded-lg text-sm text-slate-200 whitespace-pre-wrap">
                        <h4 className="font-semibold text-teal-300 mb-2">Mini-Historia:</h4>
                        {miniStory}
                    </div>
                )}
            </div>

             <button
                onClick={() => {
                    setExercise(null);
                    setUserAnswers({});
                    setValidationResults(null);
                    setError(null);
                    setDeeperExplanation("");
                    setMiniStory("");
                }}
                className="mt-8 w-full bg-gradient-to-r from-slate-500 to-slate-600 hover:from-slate-600 hover:to-slate-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out"
            >
                Practicar de Nuevo
            </button>
          </section>
        )}
      </div>
      <footer className="text-center mt-12 text-slate-400 text-xs">
        <p>&copy; {new Date().getFullYear()} FlorIA. Creado con IA para aprender inglés.</p>
      </footer>
    </div>
  );
}

export default App;


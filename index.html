<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlorIA - Aprende Inglés con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="description" content="FlorIA - Tu asistente IA para aprender inglés, versión HTML y JavaScript, con tipos de ejercicio.">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal { display: none; }
        .modal.active { display: flex; }
        .loader {
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #ec4899; 
            border-radius: 50%;
            width: 18px; height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block; 
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .icon-chevron-down, .icon-check-circle, .icon-x-circle, .icon-lightbulb, .icon-sparkles {
            width: 20px; height: 20px; stroke: currentColor; fill: none; 
            stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
        }
        .icon-sparkles { margin-left: 0.25rem; width: 16px; height: 16px;}
        .ai-generated-content { white-space: pre-wrap; }
        /* Estilos para opciones de radio en "¿Cuál es la opción?" */
        .radio-option-label {
            display: block;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background-color: #4a5568; /* slate-600 */
            border: 1px solid #718096; /* slate-500 */
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .radio-option-label:hover {
            background-color: #2d3748; /* slate-700 */
            border-color: #a0aec0; /* slate-400 */
        }
        .radio-option-label input[type="radio"] {
            margin-right: 0.5rem;
            accent-color: #ec4899; /* pink-500 */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-700 via-pink-600 to-orange-500 text-slate-100 flex flex-col items-center p-4 sm:p-8">

    <div id="apiKeyModal" class="modal fixed inset-0 bg-slate-900/80 backdrop-blur-sm items-center justify-center p-4 z-50">
        <div class="bg-slate-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="flex items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-6 w-6 text-pink-400">
                    <circle cx="12" cy="16" r="1"/><rect x="3" y="10" width="18" height="12" rx="2"/><path d="M7 10V7a5 5 0 0 1 10 0v3"/>
                </svg>
                <h2 class="text-2xl font-bold text-pink-400 text-center ml-2">Ingresa tu API Key de Gemini</h2>
            </div>
            <p class="text-slate-400 text-sm mb-4 text-center">Para utilizar FlorIA, necesitas una API Key de Google AI Studio (Gemini).</p>
            <form id="apiKeyForm">
                <input type="password" id="apiKeyInput" placeholder="Tu API Key aquí" class="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all mb-4"/>
                <p id="apiKeyError" class="text-red-400 text-sm mb-4 text-center" style="display: none;"></p>
                <button type="submit" id="validateApiKeyButton" class="w-full bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">Validar y Continuar</button>
            </form>
            <p class="text-slate-500 text-xs mt-6 text-center">Puedes obtener una API Key en <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-pink-400 hover:underline">Google AI Studio</a>.</p>
        </div>
    </div>

    <div id="appContent" class="w-full max-w-3xl bg-slate-800/80 backdrop-blur-md shadow-2xl rounded-xl p-6 sm:p-8" style="display: none;">
        <header class="mb-8 text-center">
            <h1 class="text-5xl sm:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 via-rose-400 to-amber-300">FlorIA</h1>
            <p class="text-slate-300 mt-2 text-sm sm:text-base">Tu asistente IA para conquistar el inglés.</p>
        </header>

        <section class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
            <div>
                <label for="topicSelect" class="block text-lg font-semibold text-pink-400 mb-2">Tema:</label>
                <div class="relative">
                    <select id="topicSelect" class="w-full appearance-none p-3 pr-10 rounded-lg bg-slate-700 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all text-base"></select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400"><svg class="icon-chevron-down" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                </div>
            </div>
            <div>
                <label for="difficultySelect" class="block text-lg font-semibold text-pink-400 mb-2">Dificultad:</label>
                <div class="relative">
                    <select id="difficultySelect" class="w-full appearance-none p-3 pr-10 rounded-lg bg-slate-700 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all text-base"></select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400"><svg class="icon-chevron-down" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                </div>
            </div>
            <div>
                <label for="exerciseTypeSelect" class="block text-lg font-semibold text-pink-400 mb-2">Tipo de Ejercicio:</label>
                <div class="relative">
                    <select id="exerciseTypeSelect" class="w-full appearance-none p-3 pr-10 rounded-lg bg-slate-700 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all text-base"></select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400"><svg class="icon-chevron-down" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                </div>
            </div>
        </section>
        <button id="generateExerciseButton" class="w-full bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">Generar Ejercicio</button>

        <div id="generalErrorContainer" class="my-6 p-4 bg-red-900/50 border border-red-700 text-red-300 rounded-lg text-sm" style="display: none;">
            <p class="font-semibold">¡Oops! Algo salió mal:</p>
            <p id="generalErrorMessage"></p>
        </div>
        
        <section id="exerciseSection" class="mt-8 mb-8 p-6 bg-slate-700/60 rounded-xl border border-slate-600" style="display: none;">
             <h2 id="exerciseTopicTitle" class="text-2xl font-semibold text-pink-300 mb-3"></h2>
             <div id="exerciseTopicExplanation" class="text-slate-300 mb-4 text-sm italic bg-slate-600/70 p-3 rounded-md">
                <p id="initialExplanationText" class="ai-generated-content"></p>
                <button id="deeperExplanationButton" class="mt-3 text-xs bg-sky-600 hover:bg-sky-700 text-white py-1 px-3 rounded-md transition-colors flex items-center disabled:opacity-60">Explicación Más Profunda<svg class="icon-sparkles" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2L14.5 8L21 9.5L16.5 14.5L18 21L12 17.5L6 21L7.5 14.5L3 9.5L9.5 8L12 2z"/><path d="M6.5 2.5L7.5 5L10 5.5L8.5 7.5L9 9.5L7.5 8.5L6 9.5L6.5 7.5L5 5.5L7.5 5L6.5 2.5z"/><path d="M17.5 2.5L16.5 5L14 5.5L15.5 7.5L15 9.5L16.5 8.5L18 9.5L17.5 7.5L19 5.5L16.5 5L17.5 2.5z"/></svg></button>
             </div>
             <div id="deeperExplanationLoader" class="text-center my-4 text-sky-300" style="display:none;">Buscando explicación más profunda...</div>
             <div id="deeperExplanationContent" class="my-4 p-4 bg-sky-800/30 border border-sky-700 rounded-lg text-sm text-slate-200" style="display:none;">
                <h4 class="font-semibold text-sky-300 mb-2">Explicación Detallada:</h4>
                <p id="deeperExplanationText" class="ai-generated-content"></p>
             </div>
             <form id="exerciseForm"></form>
             <button id="validateAiButton" class="mt-6 w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">Validar con IA</button>
        </section>

        <section id="validationResultsSection" class="mt-8 p-6 bg-slate-700/70 rounded-xl border border-slate-600 shadow-inner" style="display: none;">
            <h2 class="text-3xl font-semibold text-pink-300 mb-6 text-center">Resultados y Feedback</h2>
            <div id="scoreContainer" class="mb-6 p-4 bg-pink-800/50 rounded-lg text-center">
                <p class="text-xl text-slate-100">Tu puntaje:</p>
                <p id="scoreText" class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-orange-300 my-2"></p>
            </div>
            <div id="feedbackContainer" class="space-y-6 mb-8"></div>
            <div id="generalTipsContainer" class="mb-6" style="display:none;">
                <h3 class="text-xl font-semibold text-pink-400 mb-3 flex items-center">
                    <svg class="icon-lightbulb mr-2 text-yellow-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line><path d="M9 18h6v2a3 3 0 01-6 0v-2z"></path><path d="M15.5 16.5a4.5 4.5 0 00-7 0"></path><path d="M12 6a3 3 0 00-3 3h6a3 3 0 00-3-3z"></path></svg>
                    Tips para Mejorar:</h3>
                <ul id="generalTipsList" class="list-disc list-inside space-y-2 pl-4 text-slate-300 text-sm"></ul>
            </div>
            <div id="miniStoryGeneratorContainer" class="mt-6">
                 <button id="generateMiniStoryButton" class="w-full bg-gradient-to-r from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out flex items-center justify-center disabled:opacity-60">Crear Mini-Historia<svg class="icon-sparkles" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2L14.5 8L21 9.5L16.5 14.5L18 21L12 17.5L6 21L7.5 14.5L3 9.5L9.5 8L12 2z"/><path d="M6.5 2.5L7.5 5L10 5.5L8.5 7.5L9 9.5L7.5 8.5L6 9.5L6.5 7.5L5 5.5L7.5 5L6.5 2.5z"/><path d="M17.5 2.5L16.5 5L14 5.5L15.5 7.5L15 9.5L16.5 8.5L18 9.5L17.5 7.5L19 5.5L16.5 5L17.5 2.5z"/></svg></button>
            </div>
            <div id="miniStoryLoader" class="text-center my-4 text-teal-300" style="display:none;">Generando mini-historia...</div>
            <div id="miniStoryContent" class="my-4 p-4 bg-teal-800/30 border border-teal-700 rounded-lg text-sm text-slate-200" style="display:none;">
                <h4 class="font-semibold text-teal-300 mb-2">Mini-Historia:</h4>
                <p id="miniStoryText" class="ai-generated-content"></p>
            </div>
            <button id="practiceAgainButton" class="mt-8 w-full bg-gradient-to-r from-slate-500 to-slate-600 hover:from-slate-600 hover:to-slate-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out">Practicar de Nuevo</button>
        </section>
        
        <footer class="text-center mt-12 text-slate-400 text-xs">
            <p>&copy; <span id="year"></span> FlorIA. Creado con IA para aprender inglés.</p>
        </footer>
    </div>

    <script>
        // --- CONSTANTES Y CONFIGURACIÓN ---
        const API_URL_GEMINI_BASE = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`;
        let globalApiKey = "";

        const difficultyLevels = [
          { id: "simple", name: "Simple" },
          { id: "normal", name: "Normal" },
          { id: "difficult", name: "Difícil" },
          { id: "god", name: "God" },
        ];

        const allTopics = [
          { id: "a1_verb_be", name: "Verb to be (am/is/are)" },
          { id: "a1_possessive_adjectives", name: "Possessive Adjectives (my, your, his)" },
          { id: "a1_present_simple_i_you_we_they", name: "Present Simple (I, you, we, they)" },
          { id: "a1_articles_a_an_the", name: "Articles (a/an, the)" },
          { id: "a1_can_cant", name: "can / can't (ability)" },
          { id: "a2_past_simple_be", name: "Past Simple (to be: was/were)" },
          { id: "a2_past_simple_regular", name: "Past Simple (regular verbs)" },
          { id: "a2_past_simple_irregular", name: "Past Simple (common irregular verbs)" },
          { id: "a2_present_continuous", name: "Present Continuous" },
          { id: "a2_countable_uncountable_some_any", name: "Countable/Uncountable, some/any" },
          { id: "b1_present_perfect_yet_already", name: "Present Perfect (for, since, yet, already)" },
          { id: "b1_comparatives_superlatives", name: "Comparatives and Superlatives" },
          { id: "b1_will_going_to", name: "Future: will vs. going to" },
          { id: "b1_first_conditional", name: "First Conditional" },
          { id: "b1_modals_obligation_advice", name: "Modals (have to, must, should)" },
          { id: "b1plus_second_conditional", name: "Second Conditional" },
          { id: "b1plus_passive_voice_present_past", name: "Passive Voice (Present and Past Simple)" },
          { id: "b1plus_reported_speech_statements", name: "Reported Speech (Statements)" },
          { id: "b1plus_phrasal_verbs_common", name: "Common Phrasal Verbs" },
          { id: "b1plus_used_to", name: "used to" },
          { id: "b2_third_conditional", name: "Third Conditional" },
          { id: "b2_present_perfect_continuous", name: "Present Perfect Continuous" },
          { id: "b2_future_continuous_perfect", name: "Future Continuous and Future Perfect" },
          { id: "b2_modals_speculation_deduction", name: "Modals of Speculation and Deduction" },
          { id: "b2_relative_clauses_defining_nondefining", name: "Relative Clauses (defining and non-defining)" },
          { id: "c1_mixed_conditionals", name: "Mixed Conditionals" },
          { id: "c1_inversion_emphasis", name: "Inversion for Emphasis" },
          { id: "c1_advanced_passive_structures", name: "Advanced Passive Structures" },
          { id: "c1_idiomatic_expressions", name: "Idiomatic Expressions" },
          { id: "c1_collocations_phrasal_verbs_advanced", name: "Advanced Collocations and Phrasal Verbs" },
        ];

        const exerciseTypes = [
            { id: "fill_blank", name: "Completa la frase" },
            { id: "multiple_choice", name: "¿Cuál es la opción?" },
            { id: "order_words", name: "Ordena y vencerás" }
        ];

        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const apiKeyModalEl = document.getElementById('apiKeyModal');
        const apiKeyFormEl = document.getElementById('apiKeyForm');
        const apiKeyInputEl = document.getElementById('apiKeyInput');
        const apiKeyErrorEl = document.getElementById('apiKeyError');
        const validateApiKeyButtonEl = document.getElementById('validateApiKeyButton');
        const appContentEl = document.getElementById('appContent');
        const yearSpanEl = document.getElementById('year');
        const topicSelectEl = document.getElementById('topicSelect');
        const difficultySelectEl = document.getElementById('difficultySelect');
        const exerciseTypeSelectEl = document.getElementById('exerciseTypeSelect'); 
        const generateExerciseButtonEl = document.getElementById('generateExerciseButton');
        const exerciseSectionEl = document.getElementById('exerciseSection');
        const exerciseTopicTitleEl = document.getElementById('exerciseTopicTitle');
        const initialExplanationTextEl = document.getElementById('initialExplanationText');
        const deeperExplanationButtonEl = document.getElementById('deeperExplanationButton');
        const deeperExplanationContentEl = document.getElementById('deeperExplanationContent');
        const deeperExplanationTextEl = document.getElementById('deeperExplanationText');
        const exerciseFormEl = document.getElementById('exerciseForm');
        const validateAiButtonEl = document.getElementById('validateAiButton');
        const validationResultsSectionEl = document.getElementById('validationResultsSection');
        const scoreTextEl = document.getElementById('scoreText');
        const feedbackContainerEl = document.getElementById('feedbackContainer');
        const generalTipsContainerEl = document.getElementById('generalTipsContainer');
        const generalTipsListEl = document.getElementById('generalTipsList');
        const generateMiniStoryButtonEl = document.getElementById('generateMiniStoryButton');
        const miniStoryContentEl = document.getElementById('miniStoryContent');
        const miniStoryTextEl = document.getElementById('miniStoryText');
        const practiceAgainButtonEl = document.getElementById('practiceAgainButton');
        const generalErrorContainerEl = document.getElementById('generalErrorContainer');
        const generalErrorMessageEl = document.getElementById('generalErrorMessage');

        // --- ESTADO DE LA APLICACIÓN ---
        let currentExerciseData = null;
        let currentExerciseType = exerciseTypes[0].id; 
        let userAnswers = {}; 

        // --- FUNCIONES DE UTILIDAD ---
        function showElement(element, displayType = 'block') {
            if(element) element.style.display = displayType;
        }
        function hideElement(element) {
            if(element) element.style.display = 'none';
        }
        function setButtonLoadingState(button, isLoading, defaultText) {
            if (!button) return;
            const actualDefaultText = defaultText || button.dataset.defaultText || "Acción";
            if (isLoading) {
                button.disabled = true;
                if (!button.dataset.defaultText) button.dataset.defaultText = button.innerHTML; 
                button.innerHTML = `<span class="loader"></span>Cargando...`;
            } else {
                button.disabled = false;
                button.innerHTML = actualDefaultText; 
            }
        }
        function displayGeneralError(message) {
            generalErrorMessageEl.textContent = message;
            showElement(generalErrorContainerEl);
        }
        function clearGeneralError() {
            hideElement(generalErrorContainerEl);
            generalErrorMessageEl.textContent = "";
        }
        function resetUIState() {
            currentExerciseData = null;
            userAnswers = {};
            hideElement(exerciseSectionEl);
            hideElement(validationResultsSectionEl);
            hideElement(deeperExplanationContentEl);
            hideElement(miniStoryContentEl);
            clearGeneralError();
            exerciseFormEl.innerHTML = ""; 
            feedbackContainerEl.innerHTML = "";
            generalTipsListEl.innerHTML = "";
            initialExplanationTextEl.textContent = "";
            deeperExplanationTextEl.textContent = "";
            miniStoryTextEl.textContent = "";
            setButtonLoadingState(generateExerciseButtonEl, false, "Generar Ejercicio");
            setButtonLoadingState(deeperExplanationButtonEl, false, 'Explicación Más Profunda <svg class="icon-sparkles" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2L14.5 8L21 9.5L16.5 14.5L18 21L12 17.5L6 21L7.5 14.5L3 9.5L9.5 8L12 2z"/><path d="M6.5 2.5L7.5 5L10 5.5L8.5 7.5L9 9.5L7.5 8.5L6 9.5L6.5 7.5L5 5.5L7.5 5L6.5 2.5z"/><path d="M17.5 2.5L16.5 5L14 5.5L15.5 7.5L15 9.5L16.5 8.5L18 9.5L17.5 7.5L19 5.5L16.5 5L17.5 2.5z"/></svg>');
            setButtonLoadingState(validateAiButtonEl, false, "Validar con IA");
            setButtonLoadingState(generateMiniStoryButtonEl, false, 'Crear Mini-Historia<svg class="icon-sparkles" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2L14.5 8L21 9.5L16.5 14.5L18 21L12 17.5L6 21L7.5 14.5L3 9.5L9.5 8L12 2z"/><path d="M6.5 2.5L7.5 5L10 5.5L8.5 7.5L9 9.5L7.5 8.5L6 9.5L6.5 7.5L5 5.5L7.5 5L6.5 2.5z"/><path d="M17.5 2.5L16.5 5L14 5.5L15.5 7.5L15 9.5L16.5 8.5L18 9.5L17.5 7.5L19 5.5L16.5 5L17.5 2.5z"/></svg>');
        }

        // --- LLAMADAS A LA API ---
        async function callGeminiAPI(prompt, isJsonExpected = false) {
            if (!globalApiKey) {
                displayGeneralError("API Key no está configurada.");
                showApiKeyModal();
                return null;
            }
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], 'safety_settings': { 'harassment': 'BLOCK_ALL', 'hate_speech': 'BLOCK_ALL', 'sexual_content': 'BLOCK_ALL', 'dangerous_content': 'BLOCK_ALL' }  };
            if (isJsonExpected) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }

            try {
                const response = await fetch(`${API_URL_GEMINI_BASE}?key=${globalApiKey}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache' 
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text(); 
                    console.error("API Error:", response.status, errorText);
                    if (response.status === 400 || response.status === 403 || response.status === 401) { 
                        displayGeneralError("Problema con la API Key o la solicitud. Intenta recargar y reingresar la clave.");
                        showApiKeyModal();
                    } else {
                        displayGeneralError(`Error de API (${response.status}). Revisa la consola para más detalles.`);
                    }
                    return null;
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
                    if (isJsonExpected) {
                        try {
                            return JSON.parse(result.candidates[0].content.parts[0].text);
                        } catch (e) {
                            console.error("Error parseando JSON de la API:", e, "Respuesta recibida:", result.candidates[0].content.parts[0].text);
                            displayGeneralError("La IA devolvió una respuesta en formato incorrecto (no es JSON válido). Intenta de nuevo.");
                            return null;
                        }
                    }
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Respuesta inesperada de la API (estructura):", result);
                    displayGeneralError("Respuesta inesperada de la API. Revisa la consola e intenta de nuevo.");
                    return null;
                }
            } catch (err) {
                console.error("Error en callGeminiAPI (fetch o red):", err);
                displayGeneralError(`Error de red o al procesar la solicitud: ${err.message}. Verifica tu conexión.`);
                return null;
            }
        }

        // --- LÓGICA DE API KEY ---
        function showApiKeyModal() {
            globalApiKey = ""; 
            showElement(apiKeyModalEl, 'flex');
            hideElement(appContentEl);
            apiKeyInputEl.value = ""; 
            apiKeyErrorEl.textContent = ""; 
            hideElement(apiKeyErrorEl);
        }

        async function handleApiKeySubmit() {
            const key = apiKeyInputEl.value.trim();
            if (!key) {
                apiKeyErrorEl.textContent = "Por favor, ingresa una API Key.";
                showElement(apiKeyErrorEl);
                return;
            }
            
            setButtonLoadingState(validateApiKeyButtonEl, true, "Validar y Continuar");
            apiKeyErrorEl.textContent = "";
            hideElement(apiKeyErrorEl);
            
            const originalGlobalApiKey = globalApiKey; 
            globalApiKey = key; 
            
            const testPrompt = "Responde solo con la palabra 'OK' si esta API key funciona y es válida.";
            const validationResponse = await callGeminiAPI(testPrompt);
            
            if (validationResponse && validationResponse.trim().toUpperCase() === 'OK') {
                hideElement(apiKeyModalEl);
                showElement(appContentEl);
                initializeAppUI(); 
            } else {
                globalApiKey = originalGlobalApiKey; 
                apiKeyErrorEl.textContent = "API Key incorrecta o inválida. Inténtalo nuevamente.";
                showElement(apiKeyErrorEl);
                if (!validationResponse && globalApiKey === key) { 
                    showApiKeyModal(); 
                }
            }
            setButtonLoadingState(validateApiKeyButtonEl, false, "Validar y Continuar");
        }
        
        // --- LÓGICA DE EJERCICIOS ---
        function validateExerciseDataStructure(data, type) {
            if (!data || typeof data.topicExplanation !== 'string' || !Array.isArray(data.questions) || data.questions.length !== 5) {
                console.error("Validación fallida: Estructura principal del ejercicio incorrecta.", data);
                return false;
            }
            for (const q of data.questions) {
                switch (type) {
                    case 'fill_blank':
                        if (typeof q.sentence !== 'string' || !Array.isArray(q.options) || q.options.length !== 4 || typeof q.correctAnswer !== 'string' || typeof q.example !== 'string') {
                            console.error("Validación fallida (fill_blank): Estructura de pregunta incorrecta.", q); return false;
                        }
                        if (!q.options.every(opt => typeof opt === 'string')) {
                             console.error("Validación fallida (fill_blank): No todas las opciones son strings.", q.options); return false;
                        }
                        break;
                    case 'multiple_choice':
                        if (typeof q.mainQuestion !== 'string' || !Array.isArray(q.choices) || q.choices.length < 2 || typeof q.correctAnswerIndex !== 'number' || typeof q.example !== 'string') {
                            console.error("Validación fallida (multiple_choice): Estructura de pregunta incorrecta.", q); return false;
                        }
                         if (!q.choices.every(choice => typeof choice === 'string')) {
                             console.error("Validación fallida (multiple_choice): No todas las choices son strings.", q.choices); return false;
                        }
                        if (q.correctAnswerIndex < 0 || q.correctAnswerIndex >= q.choices.length) {
                            console.error("Validación fallida (multiple_choice): correctAnswerIndex fuera de rango.", q); return false;
                        }
                        break;
                    case 'order_words':
                        if (!Array.isArray(q.scrambledWords) || q.scrambledWords.length < 2 || typeof q.correctSentence !== 'string' || typeof q.example !== 'string') {
                            console.error("Validación fallida (order_words): Estructura de pregunta incorrecta.", q); return false;
                        }
                         if (!q.scrambledWords.every(word => typeof word === 'string')) {
                             console.error("Validación fallida (order_words): No todas las scrambledWords son strings.", q.scrambledWords); return false;
                        }
                        break;
                    default:
                        console.error("Tipo de ejercicio desconocido para validación:", type); return false;
                }
            }
            return true;
        }

        async function handleGenerateExercise() {
            resetUIState();
            setButtonLoadingState(generateExerciseButtonEl, true, "Generar Ejercicio");

            const topicId = topicSelectEl.value;
            const difficultyId = difficultySelectEl.value;
            currentExerciseType = exerciseTypeSelectEl.value; 
            const topicName = allTopics.find(t => t.id === topicId)?.name || topicId;
            const difficultyName = difficultyLevels.find(d => d.id === difficultyId)?.name || difficultyId;
            const exerciseTypeName = exerciseTypes.find(et => et.id === currentExerciseType)?.name || currentExerciseType;

            let exercisePromptStructure = "";
            switch (currentExerciseType) {
                case 'fill_blank':
                    exercisePromptStructure = `
                    Formato de respuesta JSON esperado (¡Sigue este formato estrictamente!):
                    {
                      "topicExplanation": "Explicación...",
                      "questions": [ 
                        { "id": "qN", "sentence": "Frase con {blank}...", "options": ["op1", "op2", "op3", "op4"], "correctAnswer": "opX", "example": "Ejemplo de uso..." },
                        // ...4 más, total 5 questions
                      ]
                    } El array 'questions' debe tener exactamente 5 elementos.`;
                    break;
                case 'multiple_choice':
                    exercisePromptStructure = `
                    Formato de respuesta JSON esperado (¡Sigue este formato estrictamente!):
                    {
                      "topicExplanation": "Explicación del tema general...",
                      "questions": [
                        { "id": "qN", "mainQuestion": "Pregunta principal (ej: ¿Cuál es la forma correcta...?)", "choices": ["Frase completa opción A", "Frase completa opción B", "Frase completa opción C"], "correctAnswerIndex": 0 (índice de la respuesta correcta en 'choices'), "example": "Ejemplo de uso del concepto..." },
                        // ...4 más, total 5 questions. Cada 'choices' array debe tener al menos 2 opciones.
                      ]
                    } El array 'questions' debe tener exactamente 5 elementos.`;
                    break;
                case 'order_words':
                    exercisePromptStructure = `
                    Formato de respuesta JSON esperado (¡Sigue este formato estrictamente!):
                    {
                      "topicExplanation": "Explicación del tema general...",
                      "questions": [
                        { "id": "qN", "scrambledWords": ["palabra1", "palabra2", "palabra3", "etc"], "correctSentence": "La oración ordenada correctamente.", "example": "Ejemplo de uso del concepto..." },
                        // ...4 más, total 5 questions. Cada 'scrambledWords' array debe tener al menos 2 palabras.
                      ]
                    } El array 'questions' debe tener exactamente 5 elementos.`;
                    break;
            }
            
            const prompt = `Eres un profesor de inglés experto. Genera un **nuevo y diferente** ejercicio de aprendizaje de inglés del tipo "${exerciseTypeName}" sobre el tema '${topicName}' con un nivel de dificultad '${difficultyName}'.
                El ejercicio debe incluir:
                1.  Una breve explicación del tema '${topicName}' en español, concisa y clara (máximo 3-4 frases).
                2.  Exactamente 5 preguntas o ítems de ejercicio **distintos a los que podrías haber generado antes para una solicitud similar**, adaptados al tipo "${exerciseTypeName}" y a la dificultad '${difficultyName}'.
                ${exercisePromptStructure}
                Asegúrate de que el JSON sea válido y la estructura sea la solicitada para el tipo de ejercicio. Intenta variar las frases y ejemplos en cada nueva generación.`;

            currentExerciseData = await callGeminiAPI(prompt, true);

            if (validateExerciseDataStructure(currentExerciseData, currentExerciseType)) {
                renderExercise(currentExerciseData, topicName, difficultyName, currentExerciseType);
                showElement(exerciseSectionEl);
            } else {
                if (currentExerciseData) { 
                     displayGeneralError("La IA generó un ejercicio con una estructura inesperada para el tipo seleccionado. Por favor, intenta generar el ejercicio de nuevo.");
                }
            }
            setButtonLoadingState(generateExerciseButtonEl, false, "Generar Ejercicio");
        }

        function renderExercise(data, topicName, difficultyName, type) {
            exerciseTopicTitleEl.textContent = `${topicName} (${difficultyName}) - ${exerciseTypes.find(et => et.id === type)?.name}`;
            initialExplanationTextEl.textContent = data.topicExplanation;
            exerciseFormEl.innerHTML = ""; 
            userAnswers = {}; 

            data.questions.forEach((q, index) => {
                const questionId = `q${index + 1}`;
                const questionDiv = document.createElement('div');
                questionDiv.className = "mb-8 p-4 border border-slate-500 rounded-lg bg-slate-700 shadow";
                
                const qNumP = document.createElement('p');
                qNumP.className = "text-slate-300 mb-1 text-sm";
                qNumP.textContent = `Pregunta ${index + 1} de ${data.questions.length}`;
                questionDiv.appendChild(qNumP);

                switch (type) {
                    case 'fill_blank':
                        const sentenceP = document.createElement('p');
                        sentenceP.className = "text-lg text-slate-100 mb-3";
                        sentenceP.textContent = q.sentence.replace('{blank}', '______');
                        questionDiv.appendChild(sentenceP);

                        const selectWrapper = document.createElement('div');
                        selectWrapper.className = "relative";
                        const selectEl = document.createElement('select');
                        selectEl.id = questionId;
                        selectEl.className = "w-full appearance-none p-3 pr-10 rounded-md bg-slate-600 border border-slate-500 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all";
                        selectEl.dataset.questionId = questionId;
                        const defaultOption = document.createElement('option');
                        defaultOption.value = ""; defaultOption.textContent = "Selecciona una opción..."; defaultOption.disabled = true;
                        selectEl.appendChild(defaultOption);
                        q.options.forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt; selectEl.appendChild(o); });
                        selectEl.value = "";
                        selectEl.addEventListener('change', (e) => userAnswers[e.target.dataset.questionId] = e.target.value);
                        selectWrapper.appendChild(selectEl);
                        const chevronIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                        chevronIcon.setAttribute("class", "icon-chevron-down pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400 h-full");
                        chevronIcon.setAttribute("viewBox", "0 0 24 24"); chevronIcon.innerHTML = `<polyline points="6 9 12 15 18 9"></polyline>`;
                        selectWrapper.appendChild(chevronIcon);
                        questionDiv.appendChild(selectWrapper);
                        break;

                    case 'multiple_choice':
                        const mainQuestionP = document.createElement('p');
                        mainQuestionP.className = "text-lg text-slate-100 mb-3";
                        mainQuestionP.textContent = q.mainQuestion;
                        questionDiv.appendChild(mainQuestionP);
                        
                        const choicesDiv = document.createElement('div');
                        q.choices.forEach((choice, choiceIndex) => {
                            const label = document.createElement('label');
                            label.className = "radio-option-label";
                            const radio = document.createElement('input');
                            radio.type = "radio";
                            radio.name = questionId; // Agrupar radios para una sola selección
                            radio.value = choiceIndex.toString(); // Guardar el índice como valor
                            radio.dataset.questionId = questionId;
                            radio.addEventListener('change', (e) => userAnswers[e.target.dataset.questionId] = e.target.value); // Guardar índice
                            label.appendChild(radio);
                            label.appendChild(document.createTextNode(choice));
                            choicesDiv.appendChild(label);
                        });
                        questionDiv.appendChild(choicesDiv);
                        break;

                    case 'order_words':
                        const wordsP = document.createElement('p');
                        wordsP.className = "text-lg text-slate-100 mb-1";
                        wordsP.textContent = "Ordena estas palabras:";
                        questionDiv.appendChild(wordsP);

                        const wordsContainer = document.createElement('div');
                        wordsContainer.className = "flex flex-wrap gap-2 mb-3 p-2 bg-slate-600 rounded-md";
                        q.scrambledWords.forEach(word => {
                            const wordSpan = document.createElement('span');
                            wordSpan.className = "bg-pink-500 text-white px-2 py-1 rounded text-sm";
                            wordSpan.textContent = word;
                            wordsContainer.appendChild(wordSpan);
                        });
                        questionDiv.appendChild(wordsContainer);

                        const inputAnswer = document.createElement('input');
                        inputAnswer.type = "text";
                        inputAnswer.id = questionId;
                        inputAnswer.dataset.questionId = questionId;
                        inputAnswer.placeholder = "Escribe la oración ordenada aquí...";
                        inputAnswer.className = "w-full p-3 rounded-lg bg-slate-600 border border-slate-500 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all";
                        inputAnswer.addEventListener('input', (e) => userAnswers[e.target.dataset.questionId] = e.target.value);
                        questionDiv.appendChild(inputAnswer);
                        break;
                }

                if (q.example) {
                    const exampleP = document.createElement('p');
                    exampleP.className = "mt-3 text-xs text-slate-400 italic";
                    exampleP.innerHTML = `<span class="font-semibold text-pink-400">Ejemplo:</span> ${q.example}`;
                    questionDiv.appendChild(exampleP);
                }
                exerciseFormEl.appendChild(questionDiv);
            });
        }

        async function handleFetchDeeperExplanation() {
            // ... (sin cambios significativos, solo asegurar que usa el topicName correcto)
            if (!currentExerciseData) return;
            setButtonLoadingState(deeperExplanationButtonEl, true, 'Explicación Más Profunda <svg class="icon-sparkles" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2L14.5 8L21 9.5L16.5 14.5L18 21L12 17.5L6 21L7.5 14.5L3 9.5L9.5 8L12 2z"/><path d="M6.5 2.5L7.5 5L10 5.5L8.5 7.5L9 9.5L7.5 8.5L6 9.5L6.5 7.5L5 5.5L7.5 5L6.5 2.5z"/><path d="M17.5 2.5L16.5 5L14 5.5L15.5 7.5L15 9.5L16.5 8.5L18 9.5L17.5 7.5L19 5.5L16.5 5L17.5 2.5z"/></svg>');
            hideElement(deeperExplanationContentEl); 
            deeperExplanationTextEl.textContent = ""; 

            const topicName = allTopics.find(t => t.id === topicSelectEl.value)?.name || topicSelectEl.value;
            const difficultyName = difficultyLevels.find(d => d.id === difficultySelectEl.value)?.name || difficultySelectEl.value;

            const prompt = `Eres un profesor de inglés experto. Proporciona una explicación más profunda y detallada sobre el tema gramatical '${topicName}' en español. Considera el nivel de dificultad '${difficultyName}'. Incluye descripción, uso, ejemplos, excepciones y consejos.`;
            
            const explanation = await callGeminiAPI(prompt);
            if (explanation) {
                deeperExplanationTextEl.textContent = explanation;
                showElement(deeperExplanationContentEl);
            }
            setButtonLoadingState(deeperExplanationButtonEl, false, 'Explicación Más Profunda <svg class="icon-sparkles" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2L14.5 8L21 9.5L16.5 14.5L18 21L12 17.5L6 21L7.5 14.5L3 9.5L9.5 8L12 2z"/><path d="M6.5 2.5L7.5 5L10 5.5L8.5 7.5L9 9.5L7.5 8.5L6 9.5L6.5 7.5L5 5.5L7.5 5L6.5 2.5z"/><path d="M17.5 2.5L16.5 5L14 5.5L15.5 7.5L15 9.5L16.5 8.5L18 9.5L17.5 7.5L19 5.5L16.5 5L17.5 2.5z"/></svg>');
        }
        
        function validateValidationDataStructure(data, type) { // Adaptada para tipo de ejercicio
            if (!data || typeof data.score !== 'number' || !Array.isArray(data.feedback) || data.feedback.length !== 5 || !Array.isArray(data.generalTips)) {
                console.error("Validación fallida: Estructura principal de la validación incorrecta.", data); return false;
            }
            for (const fb of data.feedback) {
                // 'question' puede ser la frase con blank, la pregunta principal, o las palabras desordenadas (como string)
                if (typeof fb.question !== 'string' || typeof fb.userAnswer !== 'string' || typeof fb.correctAnswer !== 'string' || typeof fb.isCorrect !== 'boolean' || typeof fb.explanation !== 'string') {
                     console.error("Validación fallida: Estructura de un item de feedback incorrecta.", fb); return false;
                }
            }
            if (!data.generalTips.every(tip => typeof tip === 'string')) {
                console.error("Validación fallida: No todos los tips son strings.", data.generalTips); return false;
            }
            return true;
        }

        async function handleValidateWithAI() {
            // ... (adaptar cómo se recolectan las respuestas y qué se envía a la IA)
            if (!currentExerciseData) { displayGeneralError("No hay ejercicio para validar."); return; }
            
            let allAnswered = true;
            for (let i = 0; i < currentExerciseData.questions.length; i++) {
                if (!userAnswers[`q${i+1}`] || userAnswers[`q${i+1}`] === "") {
                    allAnswered = false; break;
                }
            }
            if (!allAnswered) {
                displayGeneralError("Por favor, completa todas las respuestas antes de validar."); return;
            }

            clearGeneralError();
            setButtonLoadingState(validateAiButtonEl, true, "Validar con IA");
            hideElement(validationResultsSectionEl); 

            const topicName = allTopics.find(t => t.id === topicSelectEl.value)?.name || topicSelectEl.value;
            const difficultyName = difficultyLevels.find(d => d.id === difficultySelectEl.value)?.name || difficultySelectEl.value;
            const exerciseTypeName = exerciseTypes.find(et => et.id === currentExerciseType)?.name || currentExerciseType;
            
            const exerciseDetails = currentExerciseData.questions.map((q, index) => {
                let questionContent;
                let correctAnswerContent;
                switch(currentExerciseType) {
                    case 'fill_blank':
                        questionContent = q.sentence;
                        correctAnswerContent = q.correctAnswer;
                        break;
                    case 'multiple_choice':
                        questionContent = q.mainQuestion;
                        correctAnswerContent = q.choices[q.correctAnswerIndex]; // La frase correcta
                        break;
                    case 'order_words':
                        questionContent = q.scrambledWords.join(" / "); // Representación de las palabras desordenadas
                        correctAnswerContent = q.correctSentence;
                        break;
                }
                return {
                  question: questionContent,
                  userAnswer: userAnswers[`q${index+1}`] || "",
                  correctAnswer: correctAnswerContent,
                  // Para multiple_choice, la IA podría necesitar saber las opciones para un feedback más preciso,
                  // pero por ahora simplificamos. Se puede añadir 'choices' aquí si es necesario.
                };
            });

            const prompt = `Eres un tutor de inglés experto. Un estudiante ha completado un ejercicio del tipo "${exerciseTypeName}" sobre '${topicName}' con dificultad '${difficultyName}'.
                Aquí están los detalles y sus respuestas:
                ${JSON.stringify(exerciseDetails, null, 2)}
                Por favor, evalúa. Proporciona:
                1.  Puntaje general (de 5).
                2.  Feedback específico para CADA PREGUNTA. Para "multiple_choice", la 'userAnswer' es el índice de la opción elegida por el usuario y 'correctAnswer' es la frase correcta. Para "order_words", 'userAnswer' es la oración escrita por el usuario.
                3.  2-3 "Tips para mejorar" generales en español.
                Formato JSON esperado (¡Sigue este formato estrictamente!):
                {
                  "score": 3,
                  "feedback": [ { "question": "Contenido original de la pregunta...", "userAnswer": "Respuesta del usuario...", "correctAnswer": "Respuesta correcta...", "isCorrect": true/false, "explanation": "Explicación detallada..." } ],
                  "generalTips": ["Tip 1...", "Tip 2..."]
                } El array 'feedback' debe tener exactamente 5 elementos.`;

            const validationData = await callGeminiAPI(prompt, true);

            if (validateValidationDataStructure(validationData, currentExerciseType)) {
                renderValidationResults(validationData, currentExerciseType); // Pasar el tipo para renderizado específico si es necesario
                showElement(validationResultsSectionEl);
            } else {
                 if (validationData) { 
                     displayGeneralError("La IA generó una validación con una estructura inesperada. Intenta validar de nuevo.");
                }
            }
            setButtonLoadingState(validateAiButtonEl, false, "Validar con IA");
        }
        
        function renderValidationResults(results, type) { // 'type' no se usa aún pero podría ser útil
            // ... (la lógica de renderizado de feedback es mayormente la misma)
            // La principal diferencia es cómo se muestra 'fb.question' si varía mucho por tipo.
            // Por ahora, se asume que fb.question es una representación textual adecuada.
            scoreTextEl.textContent = `${results.score} / ${currentExerciseData.questions.length}`;
            feedbackContainerEl.innerHTML = ""; 

            results.feedback.forEach(fb => {
                const fbDiv = document.createElement('div');
                fbDiv.className = `p-4 rounded-lg border ${fb.isCorrect ? 'border-green-600 bg-green-900/40' : 'border-red-600 bg-red-900/40'}`;
                
                const headerDiv = document.createElement('div');
                headerDiv.className = "flex items-center mb-2";
                
                const iconSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                iconSvg.setAttribute("class", `icon-${fb.isCorrect ? 'check-circle' : 'x-circle'} ${fb.isCorrect ? 'text-green-500' : 'text-red-500'}`);
                iconSvg.setAttribute("viewBox", "0 0 24 24");
                iconSvg.setAttribute("fill", "none");
                iconSvg.setAttribute("stroke", "currentColor");
                if (fb.isCorrect) {
                    iconSvg.innerHTML = `<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>`;
                } else {
                    iconSvg.innerHTML = `<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>`;
                }
                headerDiv.appendChild(iconSvg);

                const titleH4 = document.createElement('h4');
                titleH4.className = "ml-2 text-lg font-semibold text-slate-100";
                const qTextForTitle = fb.question.length > 50 ? fb.question.substring(0, 47) + "..." : fb.question;
                titleH4.textContent = `Pregunta: "${qTextForTitle.replace('{blank}', '...')}"`; // Ajustar si {blank} no aplica
                headerDiv.appendChild(titleH4);
                fbDiv.appendChild(headerDiv);

                const answerP = document.createElement('p');
                answerP.className = `text-sm ${fb.isCorrect ? 'text-green-300' : 'text-red-300'}`;
                let userAnswerDisplay = fb.userAnswer;
                if (currentExerciseType === 'multiple_choice' && currentExerciseData && currentExerciseData.questions) {
                    // Encontrar la pregunta original para obtener el texto de la opción elegida
                    const originalQuestion = currentExerciseData.questions.find(q => 
                        (q.mainQuestion === fb.question || q.sentence === fb.question) // Heurística para encontrar la pregunta
                    );
                    if (originalQuestion && originalQuestion.choices && !isNaN(parseInt(fb.userAnswer))) {
                        userAnswerDisplay = originalQuestion.choices[parseInt(fb.userAnswer)] || fb.userAnswer;
                    }
                }
                let answerHTML = `Tu respuesta: <span class="font-medium">${userAnswerDisplay || "(No respondida)"}</span>`;
                if (!fb.isCorrect) {
                    answerHTML += `<span class="ml-2">| Correcta: <span class="font-medium">${fb.correctAnswer}</span></span>`;
                }
                answerP.innerHTML = answerHTML;
                fbDiv.appendChild(answerP);

                const explanationP = document.createElement('p');
                explanationP.className = "mt-2 text-slate-300 text-sm ai-generated-content";
                explanationP.textContent = fb.explanation;
                fbDiv.appendChild(explanationP);

                feedbackContainerEl.appendChild(fbDiv);
            });

            if (results.generalTips && results.generalTips.length > 0) {
                generalTipsListEl.innerHTML = ""; 
                results.generalTips.forEach(tip => {
                    const li = document.createElement('li');
                    li.className = "bg-slate-600/70 p-2 rounded-md";
                    li.textContent = tip;
                    generalTipsListEl.appendChild(li);
                });
                showElement(generalTipsContainerEl);
            } else {
                hideElement(generalTipsContainerEl);
            }
        }

        async function handleGenerateMiniStory() {
            // ... (sin cambios significativos)
            if (!currentExerciseData) return; 
            setButtonLoadingState(generateMiniStoryButtonEl, true, '✨ Crear Mini-Historia...');
            hideElement(miniStoryContentEl);
            miniStoryTextEl.textContent = "";

            const topicName = allTopics.find(t => t.id === topicSelectEl.value)?.name || topicSelectEl.value;
            const difficultyName = difficultyLevels.find(d => d.id === difficultySelectEl.value)?.name || difficultySelectEl.value;

            const prompt = `Eres un escritor creativo y profesor de inglés. Escribe una mini-historia (3 a 5 frases cortas) en inglés. Utiliza el tema gramatical: '${topicName}', con dificultad '${difficultyName}'. Incluye traducción breve al español entre paréntesis.`;
            
            const story = await callGeminiAPI(prompt);
            if (story) {
                miniStoryTextEl.textContent = story;
                showElement(miniStoryContentEl);
            }
            setButtonLoadingState(generateMiniStoryButtonEl, false, 'Crear Mini-Historia<svg class="icon-sparkles" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2L14.5 8L21 9.5L16.5 14.5L18 21L12 17.5L6 21L7.5 14.5L3 9.5L9.5 8L12 2z"/><path d="M6.5 2.5L7.5 5L10 5.5L8.5 7.5L9 9.5L7.5 8.5L6 9.5L6.5 7.5L5 5.5L7.5 5L6.5 2.5z"/><path d="M17.5 2.5L16.5 5L14 5.5L15.5 7.5L15 9.5L16.5 8.5L18 9.5L17.5 7.5L19 5.5L16.5 5L17.5 2.5z"/></svg>');
        }

        function handlePracticeAgain() {
            resetUIState();
        }

        // --- INICIALIZACIÓN DE LA UI PRINCIPAL ---
        function initializeAppUI() {
            topicSelectEl.innerHTML = ""; 
            allTopics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.id;
                option.textContent = topic.name;
                topicSelectEl.appendChild(option);
            });

            difficultySelectEl.innerHTML = ""; 
            difficultyLevels.forEach(level => {
                const option = document.createElement('option');
                option.value = level.id;
                option.textContent = level.name;
                difficultySelectEl.appendChild(option);
            });

            exerciseTypeSelectEl.innerHTML = ""; // Poblar nuevo selector
            exerciseTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                exerciseTypeSelectEl.appendChild(option);
            });
            currentExerciseType = exerciseTypeSelectEl.value; // Establecer tipo por defecto
            
            resetUIState();
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            yearSpanEl.textContent = new Date().getFullYear();
            showElement(apiKeyModalEl, 'flex'); 

            apiKeyFormEl.addEventListener('submit', (event) => {
                event.preventDefault();
                handleApiKeySubmit();
            });

            generateExerciseButtonEl.addEventListener('click', handleGenerateExercise);
            deeperExplanationButtonEl.addEventListener('click', handleFetchDeeperExplanation);
            validateAiButtonEl.addEventListener('click', handleValidateWithAI);
            generateMiniStoryButtonEl.addEventListener('click', handleGenerateMiniStory);
            practiceAgainButtonEl.addEventListener('click', handlePracticeAgain);

            topicSelectEl.addEventListener('change', resetUIState);
            difficultySelectEl.addEventListener('change', resetUIState);
            exerciseTypeSelectEl.addEventListener('change', () => { // Actualizar tipo y resetear
                currentExerciseType = exerciseTypeSelectEl.value;
                resetUIState();
            });
        });

    </script>
</body>
</ht
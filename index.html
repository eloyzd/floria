<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlorIA - Aprende Inglés con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="description" content="FlorIA - Tu asistente IA para aprender inglés, versión HTML y JavaScript.">
    <style>
        /* Estilos adicionales si fueran necesarios, aunque Tailwind debería cubrir la mayoría */
        body {
            font-family: sans-serif;
        }
        .modal {
            display: none; /* Oculto por defecto */
        }
        .modal.active {
            display: flex; /* Mostrar cuando está activo */
        }
        /* Estilo para el loader */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #ec4899; /* Pink */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block; /* Para que esté en la misma línea que el texto */
            margin-right: 0.5rem; /* Espacio a la derecha */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-700 via-pink-600 to-orange-500 text-slate-100 flex flex-col items-center p-4 sm:p-8">

    <div id="apiKeyModal" class="modal fixed inset-0 bg-slate-900/80 backdrop-blur-sm items-center justify-center p-4 z-50">
        <div class="bg-slate-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="flex items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-6 w-6 text-pink-400">
                    <circle cx="12" cy="16" r="1"/><rect x="3" y="10" width="18" height="12" rx="2"/><path d="M7 10V7a5 5 0 0 1 10 0v3"/>
                </svg>
                <h2 class="text-2xl font-bold text-pink-400 text-center ml-2">Ingresa tu API Key de Gemini</h2>
            </div>
            <p class="text-slate-400 text-sm mb-4 text-center">
                Para utilizar FlorIA, necesitas una API Key de Google AI Studio (Gemini).
            </p>
            <form id="apiKeyForm">
                <input
                    type="password"
                    id="apiKeyInput"
                    placeholder="Tu API Key aquí"
                    class="w-full p-3 rounded-lg bg-slate-700 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all mb-4"
                />
                <p id="apiKeyError" class="text-red-400 text-sm mb-4 text-center" style="display: none;"></p>
                <button
                    type="submit"
                    id="validateApiKeyButton"
                    class="w-full bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                >
                    Validar y Continuar
                </button>
            </form>
            <p class="text-slate-500 text-xs mt-6 text-center">
                Puedes obtener una API Key en <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-pink-400 hover:underline">Google AI Studio</a>.
            </p>
        </div>
    </div>

    <div id="appContent" class="w-full max-w-3xl bg-slate-800/80 backdrop-blur-md shadow-2xl rounded-xl p-6 sm:p-8" style="display: none;">
        <header class="mb-8 text-center">
            <h1 class="text-5xl sm:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 via-rose-400 to-amber-300">
                FlorIA
            </h1>
            <p class="text-slate-300 mt-2 text-sm sm:text-base">Tu asistente IA para conquistar el inglés.</p>
        </header>

        <section class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
            <div>
                <label for="topicSelect" class="block text-lg font-semibold text-pink-400 mb-2">Elige un tema:</label>
                <div class="relative">
                    <select id="topicSelect" class="w-full appearance-none p-3 pr-10 rounded-lg bg-slate-700 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all text-base">
                        </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>
                </div>
            </div>
            <div>
                <label for="difficultySelect" class="block text-lg font-semibold text-pink-400 mb-2">Elige la dificultad:</label>
                <div class="relative">
                    <select id="difficultySelect" class="w-full appearance-none p-3 pr-10 rounded-lg bg-slate-700 border border-slate-600 text-slate-100 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition-all text-base">
                        </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>
                </div>
            </div>
        </section>
        <button id="generateExerciseButton" class="w-full bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
            Generar Ejercicio
        </button>

        <div id="generalErrorContainer" class="my-6 p-4 bg-red-900/50 border border-red-700 text-red-300 rounded-lg text-sm" style="display: none;">
            <p class="font-semibold">¡Oops! Algo salió mal:</p>
            <p id="generalErrorMessage"></p>
        </div>
        
        <section id="exerciseSection" class="mt-8 mb-8 p-6 bg-slate-700/60 rounded-xl border border-slate-600" style="display: none;">
            <h2 id="exerciseTopicTitle" class="text-2xl font-semibold text-pink-300 mb-3"></h2>
             <div id="exerciseTopicExplanation" class="text-slate-300 mb-4 text-sm italic bg-slate-600/70 p-3 rounded-md">
                <p id="initialExplanationText"></p>
                <button id="deeperExplanationButton" class="mt-3 text-xs bg-sky-600 hover:bg-sky-700 text-white py-1 px-3 rounded-md transition-colors flex items-center disabled:opacity-60">
                    ✨ Explicación Más Profunda
                    <span id="deeperExplanationLoader" class="loader" style="display: none; margin-left: 0.5rem;"></span>
                </button>
             </div>
             <div id="deeperExplanationContent" class="my-4 p-4 bg-sky-800/30 border border-sky-700 rounded-lg text-sm text-slate-200 whitespace-pre-wrap" style="display:none;">
                <h4 class="font-semibold text-sky-300 mb-2">Explicación Detallada:</h4>
                <p id="deeperExplanationText"></p>
             </div>
             <form id="exerciseForm">
                </form>
             <button id="validateAiButton" class="mt-6 w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                Validar con IA
            </button>
        </section>

        <section id="validationResultsSection" class="mt-8 p-6 bg-slate-700/70 rounded-xl border border-slate-600 shadow-inner" style="display: none;">
            </section>
        
        <footer class="text-center mt-12 text-slate-400 text-xs">
            <p>&copy; <span id="year"></span> FlorIA. Creado con IA para aprender inglés.</p>
        </footer>
    </div>

    <script>
        // --- CONSTANTES Y CONFIGURACIÓN ---
        const API_URL_GEMINI_BASE = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`;
        let globalApiKey = "";

        const difficultyLevels = [
          { id: "simple", name: "Simple" },
          { id: "normal", name: "Normal" },
          { id: "difficult", name: "Difícil" },
          { id: "god", name: "God" },
        ];

        const allTopics = [
          { id: "a1_verb_be", name: "Verb to be (am/is/are)" },
          { id: "a1_possessive_adjectives", name: "Possessive Adjectives (my, your, his)" },
          { id: "a1_present_simple_i_you_we_they", name: "Present Simple (I, you, we, they)" },
          { id: "a1_articles_a_an_the", name: "Articles (a/an, the)" },
          { id: "a1_can_cant", name: "can / can't (ability)" },
          { id: "a2_past_simple_be", name: "Past Simple (to be: was/were)" },
          { id: "a2_past_simple_regular", name: "Past Simple (regular verbs)" },
          { id: "a2_past_simple_irregular", name: "Past Simple (common irregular verbs)" },
          { id: "a2_present_continuous", name: "Present Continuous" },
          { id: "a2_countable_uncountable_some_any", name: "Countable/Uncountable, some/any" },
          { id: "b1_present_perfect_yet_already", name: "Present Perfect (for, since, yet, already)" },
          { id: "b1_comparatives_superlatives", name: "Comparatives and Superlatives" },
          { id: "b1_will_going_to", name: "Future: will vs. going to" },
          { id: "b1_first_conditional", name: "First Conditional" },
          { id: "b1_modals_obligation_advice", name: "Modals (have to, must, should)" },
          { id: "b1plus_second_conditional", name: "Second Conditional" },
          { id: "b1plus_passive_voice_present_past", name: "Passive Voice (Present and Past Simple)" },
          { id: "b1plus_reported_speech_statements", name: "Reported Speech (Statements)" },
          { id: "b1plus_phrasal_verbs_common", name: "Common Phrasal Verbs" },
          { id: "b1plus_used_to", name: "used to" },
          { id: "b2_third_conditional", name: "Third Conditional" },
          { id: "b2_present_perfect_continuous", name: "Present Perfect Continuous" },
          { id: "b2_future_continuous_perfect", name: "Future Continuous and Future Perfect" },
          { id: "b2_modals_speculation_deduction", name: "Modals of Speculation and Deduction" },
          { id: "b2_relative_clauses_defining_nondefining", name: "Relative Clauses (defining and non-defining)" },
          { id: "c1_mixed_conditionals", name: "Mixed Conditionals" },
          { id: "c1_inversion_emphasis", name: "Inversion for Emphasis" },
          { id: "c1_advanced_passive_structures", name: "Advanced Passive Structures" },
          { id: "c1_idiomatic_expressions", name: "Idiomatic Expressions" },
          { id: "c1_collocations_phrasal_verbs_advanced", name: "Advanced Collocations and Phrasal Verbs" },
        ];

        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyForm = document.getElementById('apiKeyForm');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiKeyError = document.getElementById('apiKeyError');
        const validateApiKeyButton = document.getElementById('validateApiKeyButton');
        const appContent = document.getElementById('appContent');
        const yearSpan = document.getElementById('year');
        const topicSelect = document.getElementById('topicSelect');
        const difficultySelect = document.getElementById('difficultySelect');
        const generateExerciseButton = document.getElementById('generateExerciseButton');
        const exerciseSection = document.getElementById('exerciseSection');
        const validationResultsSection = document.getElementById('validationResultsSection');
        const generalErrorContainer = document.getElementById('generalErrorContainer');
        const generalErrorMessage = document.getElementById('generalErrorMessage');
        // (Añadiremos más referencias a medida que construyamos las secciones)

        // --- ESTADO DE LA APLICACIÓN (SIMULADO) ---
        let currentExerciseData = null;
        let currentUserAnswers = {};
        let currentValidationResults = null;
        let currentDeeperExplanation = "";
        let currentMiniStory = "";

        // --- FUNCIONES DE UTILIDAD ---
        function showElement(element) {
            if(element) element.style.display = (element.tagName === 'SECTION' || element.id === 'appContent' || element.id === 'deeperExplanationContent' || element.id === 'generalErrorContainer') ? 'block' : 'flex'; // flex para el modal
        }
        function hideElement(element) {
            if(element) element.style.display = 'none';
        }
        function setButtonLoading(button, isLoading, defaultText) {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<span class="loader"></span>Cargando...`;
            } else {
                button.disabled = false;
                button.innerHTML = defaultText;
            }
        }
        function displayGeneralError(message) {
            generalErrorMessage.textContent = message;
            showElement(generalErrorContainer);
        }
        function clearGeneralError() {
            hideElement(generalErrorContainer);
            generalErrorMessage.textContent = "";
        }


        // --- LÓGICA DE API KEY ---
        async function handleApiKeySubmit() {
            const key = apiKeyInput.value.trim();
            if (!key) {
                apiKeyError.textContent = "Por favor, ingresa una API Key.";
                showElement(apiKeyError);
                return;
            }
            
            setButtonLoading(validateApiKeyButton, true, "Validar y Continuar");
            apiKeyError.textContent = "";
            hideElement(apiKeyError);

            try {
                const testPrompt = "Responde 'OK' si esta API key funciona.";
                const payload = { contents: [{ role: "user", parts: [{ text: testPrompt }] }] };
                const response = await fetch(`${API_URL_GEMINI_BASE}?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    globalApiKey = key;
                    hideElement(apiKeyModal);
                    showElement(appContent);
                    initializeAppUI(); // Cargar temas, etc. después de validar la key
                } else {
                    apiKeyError.textContent = "API Key incorrecta o inválida. Inténtalo nuevamente.";
                    showElement(apiKeyError);
                    console.error("API Key validation failed:", response.status, await response.text());
                }
            } catch (err) {
                console.error("Error validating API Key:", err);
                apiKeyError.textContent = "Error al validar la API Key. Verifica tu conexión o la clave.";
                showElement(apiKeyError);
            } finally {
                setButtonLoading(validateApiKeyButton, false, "Validar y Continuar");
            }
        }
        
        // --- INICIALIZACIÓN DE LA UI PRINCIPAL ---
        function initializeAppUI() {
            // Poblar dropdown de temas
            allTopics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.id;
                option.textContent = topic.name;
                topicSelect.appendChild(option);
            });

            // Poblar dropdown de dificultad
            difficultyLevels.forEach(level => {
                const option = document.createElement('option');
                option.value = level.id;
                option.textContent = level.name;
                difficultySelect.appendChild(option);
            });

            // Añadir event listeners a los controles principales
            // generateExerciseButton.addEventListener('click', handleGenerateExercise);
            // (Más listeners se añadirán aquí)
        }


        // --- LÓGICA PRINCIPAL Y EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            yearSpan.textContent = new Date().getFullYear();
            
            // Mostrar modal de API Key al inicio
            showElement(apiKeyModal);

            apiKeyForm.addEventListener('submit', (event) => {
                event.preventDefault();
                handleApiKeySubmit();
            });
        });

        // --- MÁS FUNCIONES (generateExercise, validate, etc.) IRÁN AQUÍ ---
        // Por ahora, esto establece la estructura y el modal de API Key.

    </script>
</body>
</html>